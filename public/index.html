<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
		<title>G1social - Aster</title>
		<!-- import amap-->
		<link rel="stylesheet" href="https://cache.amap.com/lbs/static/main1119.css"/>
		<script src="https://cache.amap.com/lbs/static/es5.min.js"></script>
		<script src="https://webapi.amap.com/maps?v=1.4.8&key=b38f7391301b4f411589921db716b35a"></script>
		<script src="https://cache.amap.com/lbs/static/addToolbar.js"></script>
		<!-- import jquery-->
		<script src="https://cdn.bootcss.com/jquery/2.1.1/jquery.min.js"></script>
		<!-- import bootstrap-->
		<link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    	<style>
    		#navigation {
    			height: 50px;
    		}
			#container {
				top: 50px;
				width: 100%;
				height: calc(100% - 50px);
				position: absolute;
          	}
          	#button-add {
				width: 60px;
				height: 60px;
				border-radius: 55px;
				right: 24px;
				bottom: 24px;
				position: absolute;
				text-align: center;
				display: inline-flex;
				flex-direction: column;
				justify-content: center;
				align-items: center;
				font-size: 18px;
				font-weight: bold;
				text-decoration: none
			}
			.alert {
				bottom: 0;
				width: 60%;
				margin: auto;
				font-size: 18px;
				text-align: center;
				position: relative;
				display: none;
			}

			#modal-upload, #modal-view {
				margin: auto;
				width: 80%;
				position: relative;
			}

			#sitedpost_position, #sitedpost_date {
				width: 100%;
				margin: auto;
				position: relative;
			}

			#sitedpost_content, #sitedpost_content_view {
				width: 100%;
				margin: auto;
				position: relative;
				resize: none;
				height: 60%;
			}

		</style>
	</head>



	<body>
		<nav id="navigation" class="navbar navbar-default" role="navigation">
			<div class="container-fluid">
				<div class="navbar-header">
					<a class="navbar-brand" href="#">G1social</a>
        			<p class="navbar-text">华东理工大学奉贤校区</p>
				</div>
			</div>
		</nav>

		<div id="container"></div>

		<button type="button" id="button-add" class="btn btn-primary" onclick="addSitedpost()"><span><i class="glyphicon glyphicon-plus"></i></span></button>

		<div id="alert-choose" class="alert alert-info">请在地图上选择一个位置。</div>
		<div id="alert-success" class="alert alert-success">数据提交成功！</div>
		<div id="alert-fail" class="alert alert-danger">数据提交失败！</div>

		<div class="modal fade" id="modal-upload" role="dialog">
			<div class="modal-content">
				<form id = "form-upload">
					<input name="utf8" type="hidden" value="&#x2713;" />
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<h4 class="modal-title" id="myModalLabel">新建条目</h4>
        			</div>
					<div class="modal-body" id="modal-body">
						<div class="field" id="field-position">
							<label for="sitedpost_position">您选择的位置：</label><br />
							<input type="text" name="sitedpost[position]" id="sitedpost_position" readonly="true"/>
						</div>
						<div class="field">
							<br /><label for="sitedpost_content">条目内容：</label><br />
							<textarea name="sitedpost[content]" id="sitedpost_content"></textarea>
						</div>
					</div>
					<div class="modal-footer"><center>
						<input type="button" id="submitt" class="btn btn-primary" value="分享" onClick="upload()"></center>
					</div>
				</form>
			</div>
		</div><!-- /.modal-upload -->

		<div class="modal fade" id="modal-view" role="dialog">
			<div class="modal-content">
				<input name="utf8" type="hidden" value="&#x2713;" />
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
					<h4 class="modal-title" id="myModalLabel">阅读条目</h4>
        		</div>
				<div class="modal-body" id="modal-body">
					<div class="field" id="field-date">
						<label for="sitedpost_date">添加时间：</label><br />
						<input type="text" id="sitedpost_date" readonly="true"/>
					</div>
					<div class="field">
						<br /><label for="sitedpost_content_view">条目内容：</label><br />
						<textarea id="sitedpost_content_view" readonly="true"></textarea>
					</div>
				</div>
			</div>
		</div>



		<script>
			var map = new AMap.Map('container', {
    			resizeEnable: true,
    			zoom:200,
    			center: [121.5041112900, 30.8310372493]
			});

			map.setFitView(container);
			refresh();

			var choosingPosition = false;

			function addSitedpost() {
				$("#alert-choose").fadeIn("fast");
				setTimeout(function(){
					$("#alert-choose").fadeOut("fast");
				}, 2000);
				choosingPosition = true;
			}

			var clickEventListener = map.on('click', function(e) {
				if (choosingPosition) {
					choosingPosition = false;
					document.getElementById('alert-choose').style.display = 'none';
					document.getElementById('alert-success').style.display = 'none';
					document.getElementById('alert-fail').style.display = 'none';
					document.getElementById('form-upload').reset();
					document.getElementById('modal-upload').setAttribute('data-backdrop', 'static');
					document.getElementById('sitedpost_position').setAttribute('value', e.lnglat.getLng() + ' ' + e.lnglat.getLat());

					$('#modal-upload').modal('show');
				}
			});

			function upload() {
				$('#modal-upload').modal('hide');
				$.ajax({  
					type: "POST",
					dataType:"text",
					url:"/sitedposts",
					data:$('#form-upload').serialize(),
					async: false,  
					error: function() {
						$("#alert-fail").fadeIn("fast");
						setTimeout(function(){
							$("#alert-fail").fadeOut("fast");
						}, 2000);
					},
					success: function() {
						$("#alert-success").fadeIn("fast");
						setTimeout(function(){
							$("#alert-success").fadeOut("fast");
						}, 2000);
						refresh();
					}  
				});
			}

			function refresh() {
				$.getJSON("/sitedposts", function(result) {
					for(var key in result) {
						var pos = result[key]['position'].split(' ');
						var marker = new AMap.Marker({
							icon: "https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png",
							position: [pos[0], pos[1]],
							clickable : true
						});
						
						map.add(marker);

						AMap.event.addListener(marker, 'click', showContent);
						marker.date = result[key]['created_at'];
						marker.content = result[key]['content'];
					}
  				});
			}

			function showContent(e) {
				document.getElementById('alert-choose').style.display = 'none';
				document.getElementById('alert-success').style.display = 'none';
				document.getElementById('alert-fail').style.display = 'none';
				document.getElementById('sitedpost_date').value = e.target.date;
				document.getElementById('sitedpost_content_view').value = e.target.content;
				$('#modal-view').modal('show');
			}

		</script>
	</body>
</html>

